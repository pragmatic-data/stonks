models:
- name: rpt_positions_daily_values
  description: This model provides a comprehensive daily snapshot of reported positions,
    including position changes, valuations, and associated metadata. It integrates
    calendar dates with position data to facilitate time-based analysis of financial
    positions.

  config:
    contract: {enforced: true}

  data_tests:
    - dbt_utils.unique_combination_of_columns:      #-- Max one version per effectivity date
        combination_of_columns: 
          - POSITION_HKEY
          - calendar_date

    - dbt_utils.expression_is_true:
        expression: position_value = mark_price * quantity
    - dbt_utils.expression_is_true:
        expression: fifo_pnl_unrealized = position_value - COST_BASIS_MONEY

  columns:
  # Keys
  - name: position_value_scd_hkey
    description: Surrogate key for the position value.
    data_type: binary
    data_tests:
      - unique
      - not_null
  - name: portfolio_hkey
    description: Hash key for the portfolio.
    data_type: binary
  - name: position_hkey
    description: Hash key for the position.
    data_type: binary
  - name: position_scd_hkey
    description: Surrogate key for the position.
    data_type: binary
  - name: security_hkey
    description: Hash key for the security.
    data_type: binary
  - name: security_scd_hkey
    description: Surrogate key for the security.
    data_type: binary
  - name: broker_code
    description: Code representing the broker.
    data_type: text
    data_tests:
      - not_null
  - name: client_account_code
    description: Code for the client account.
    data_type: text
    data_tests:
      - not_null
  - name: listing_exchange
    description: Exchange where the security is listed.
    data_type: text
    data_tests:
      - not_null
  - name: security_code
    description: Code representing the security.
    data_type: text
    data_tests:
      - not_null
  - name: underlying_security_code
    description: Code for the underlying security.
    data_type: text

  # Account & Security identification
  - name: account_alias
    description: Alias for the account associated with the position.
    data_type: text
    data_tests:
      - not_null
  - name: security_symbol
    description: Symbol representing the security in the position.
    data_type: text
    data_tests:
      - not_null
  - name: security_name
    description: Name of the security in the position.
    data_type: text
    data_tests:
      - not_null
  - name: asset_class
    description: Classification of the asset type.
    data_type: text
    data_tests:
      - not_null

  # CALENDAR DATE 
  - name: calendar_date
    description: Date from the calendar used for time-based analysis.
    data_type: date
    data_tests:
      - not_null

  # Position 
  - name: position_change_date
    description: Date when the position change occurred.
    data_type: date
  - name: quantity
    description: Number of units in the position.
    data_type: number
  - name: side
    description: Indicates whether the position is a buy or sell.
    data_type: text
  - name: trading_currency
    description: Currency in which the position is traded.
    data_type: text

  # Position valuation
  - name: position_value_date
    description: Date when the position value is recorded.
    data_type: date
  - name: adjusted_effectivity_date
    description: Adjusted date for the effectivity of the position.
    data_type: timestamp_ntz
  - name: cost_basis_price
    description: Price used as the cost basis for the position.
    data_type: number
  - name: mark_price
    description: Current market price of the security.
    data_type: number
  - name: cost_basis_money
    description: Monetary value of the cost basis for the position.
    data_type: number
  - name: position_value
    description: Total value of the position.
    data_type: number
  - name: percent_of_nav
    description: Percentage of the position value relative to the net asset value.
    data_type: number
  - name: fifo_pnl_unrealized
    description: Unrealized profit or loss using FIFO method.
    data_type: number
  - name: gain_pct_fx
    description: Percentage gain from foreign exchange fluctuations.
    data_type: number

  # Calculation on NAV
  - name: approx_side_NAV
    description: Estimation of the portfolio NAV for the same side of the position.
    data_type: number
  - name: avg_long_NAV
    description: Average of the estimations of the portfolio NAV for the Long positions.
    data_type: number
  - name: avg_short_NAV
    description: Average of the estimations of the portfolio NAV for the Short positions.
    data_type: number
  - name: avg_net_NAV
    description: Net value of Long and Short positions.
      Algebric sum of the estimations of the portfolio NAV for Long and Short positions.
    data_type: number
  - name: avg_gross_NAV
    description: The estimations of the sum of the abosulte NAV of all the positions.
      Absolute sum of the estimations of the portfolio NAV for Long and Short positions.
    data_type: number

  # Option fields
  - name: underlying_listing_exchange
    description: Exchange where the underlying security is listed.
    data_type: text
  - name: underlying_symbol
    description: Symbol of the underlying security.
    data_type: text
  - name: put_call
    description: Indicates whether the option is a put or call.
    data_type: text
  - name: multiplier
    description: Multiplier for the option contract.
    data_type: number
  - name: strike
    description: Strike price of the option.
    data_type: number
  - name: expiry
    description: Expiration date of the option.
    data_type: date
  - name: fx_rate_to_base
    description: Foreign exchange rate to the base currency.
    data_type: number
  - name: position_value_base
    description: Value of the position in the base currency.
    data_type: number
  - name: cost_basis_base_approx
    description: Approximate cost basis in the base currency.
    data_type: number
  - name: gain_base
    description: Gain in the base currency.
    data_type: number

  # Calendar based filters
  - name: day
    description: Day of the month from the calendar.
    data_type: number
  - name: day_name
    description: Name of the day from the calendar.
    data_type: text
  - name: month
    description: Month from the calendar.
    data_type: number
  - name: month_name
    description: Name of the month from the calendar.
    data_type: text
  - name: quarter_number
    description: Quarter number from the calendar.
    data_type: number
  - name: quarter
    description: Quarter from the calendar.
    data_type: text
  - name: year
    description: Year from the calendar.
    data_type: number
  - name: year_quarter
    description: Year and quarter from the calendar.
    data_type: text

  # Metadata
  - name: record_source
    description: Source of the record data.
    data_type: text
  - name: ingestion_ts_utc
    description: Timestamp when the data was ingested in UTC.
    data_type: timestamp_ntz
  - name: hist_load_ts_utc
    description: Historical load timestamp in UTC.
    data_type: timestamp_ntz
  - name: position_value_version_number
    description: Version number of the position value.
    data_type: number
  - name: adjusted_position_value_valid_from
    description: Start date when the adjusted position value is valid.
    data_type: timestamp_ntz
  - name: position_value_valid_from
    description: Start date when the position value is valid.
    data_type: date
  - name: position_value_valid_to
    description: End date when the position value is valid.
    data_type: date
  - name: value_is_current
    description: Indicates if the value is current.
    data_type: boolean
  - name: position_effectivity_date
    description: Effectivity date of the position.
    data_type: date
  - name: position_ingestion_ts_utc
    description: Timestamp when the position data was ingested in UTC.
    data_type: timestamp_ntz
  - name: position_hist_load_ts_utc
    description: Historical load timestamp for the position in UTC.
    data_type: timestamp_ntz
  - name: position_version_count
    description: Count of versions for the position.
    data_type: number
  - name: position_version_number
    description: Version number of the position.
    data_type: number
  - name: position_valid_from
    description: Start date when the position is valid.
    data_type: date
  - name: position_valid_to
    description: End date when the position is valid.
    data_type: date
  - name: position_is_current
    description: Indicates if the position is current.
    data_type: boolean
  - name: security_effectivity_date
    description: Effectivity date of the security.
    data_type: timestamp_ntz
  - name: security_ingestion_ts_utc
    description: Timestamp when the security data was ingested in UTC.
    data_type: timestamp_ntz
  - name: security_hist_load_ts_utc
    description: Historical load timestamp for the security in UTC.
    data_type: timestamp_ntz
  - name: security_version_count
    description: Count of versions for the security.
    data_type: number
  - name: security_version_number
    description: Version number of the security.
    data_type: number
  - name: security_valid_from
    description: Start date when the security is valid.
    data_type: timestamp_ntz
  - name: security_valid_to
    description: End date when the security is valid.
    data_type: timestamp_ntz
  - name: security_is_current
    description: Indicates if the security is current.
    data_type: boolean
