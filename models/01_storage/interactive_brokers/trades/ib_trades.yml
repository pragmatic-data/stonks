version: 2

models:

  - name: STG_IB_TRADES
    description: |
      Trades in all asset classes in portfolios hold on Interactive Broker.
      
      The trades are at position level (with the exception of CASH trades to exchange funds).
      The main types of trades are standard trades for whole securities and fractional trades.
      
      The Transaction Type column has some values (Withholding Tax, Other Fees) that overlap across categories.
    data_tests:
      - has_sortable_versions:        #-- MAX 1 DISTINCT version in STG (HIST input) x eff date
          key_column: TRADE_HKEY
          diff_column: TRADE_HDIFF
          sort_columns: EFFECTIVITY_DATE, RECORD_SOURCE
      - dbt_utils.unique_combination_of_columns:      #-- Max one version per report
          combination_of_columns:
            - Transaction_ID
            - RECORD_SOURCE   #-- all files have all TXs since the start of the year => unique in each file

    columns:
      - name: TRADE_HKEY
        description: HKEY / PK is not null
        data_tests:
          - not_null
      - name: Transaction_ID
        description: BK is not null
        data_tests:
          - not_null
      - name: concat(BROKER_CODE, LISTING_EXCHANGE, SECURITY_SYMBOL, SECURITY_CODE)
        description: Position BK is not null for position related transactions
        data_tests:
          - not_null:
              where: ASSET_CLASS not in ('CASH', 'FOP')
      - name: SECURITY_CODE
        data_tests:
          - relationships:
              to: ref('STG_IB_TRADES_SECURITY')
              field: SECURITY_CODE
              where: ASSET_CLASS not in ('CASH', 'FOP') and trade_date_time >= '2024-01-01'
                      # Before 2024 some short position where opened and closed between exports
